{% extends 'sitemngr/base.html' %}
{% load staticfiles %}

{% block subtitle %}
Index
{% endblock %}

{% block javascript %}
<script type="text/javascript">
	$(document).ready(function() {
		console.log('Document ready');
		$('#overlay').load('http://tracker.talkinlocal.org/sitemngr/overlay/');
		$('.message').bind('click', function() {
           $(this).hide(250);
        });
		$('#tt1').tooltip();
		$('#tt2').tooltip();
		$('#tt3').tooltip();
		$('#tt4').tooltip();
		$('#tt5').tooltip();
		setTimeout(function() {
			$('#alert_notices').fadeOut(5000);
			$('#alert_flag').fadeOut(5000);
		}, 30000);
	});
	function get_tags() {
		var keyword = $('#omnibox').val();
		var flags = $('#omni_flags').val();
		if (flags == '')
		  flags = '_'
		$('#search_results').show();
		$('#search_results').load('http://tracker.talkinlocal.org/sitemngr/get_search_results/' + keyword + '/' + flags);
	}
	function toggleSection(which) {
	   $("#" + which).toggle(200);
	}
	function edit(n) {
		console.log('Edit ' + n);
		var id = $('#id' + n).text();
		var start = $('#start' + n).text();
		var end = $('#end' + n).text();
		var status = $('#status' + n).text();
		console.log(id + ', ' + start + ', ' + end + ', ' + status);
		$('#id' + n).html('<input type="text" id="id' + n + '_edit" value="' + $('#id' + n).text() + '">');
		$('#start' + n).html('<input type="text" id="start' + n + '_edit" value="' + $('#start' + n).text() + '">');
		$('#end' + n).html('<input type="text" id="end' + n + '_edit" value="' + $('#end' + n).text() + '">');
		$('#status' + n).html('<input type="text" id="status' + n + '_edit" value="' + $('#status' + n).text() + '">');
		$('#link' + n).html('<a class="label label-important" onclick="cancel(' + n + ')">Cancel</a> <td><a class="label label-success" onclick="save(' + n + ')">Save</a></td>');
		// $('#tr' + n).append('<td><a onclick="save(' + n + ')">Save</a></td>');
	}
	function cancel(n) {
		console.log('Cancel  ' + n);
		var id = $('#id' + n).html().split('"')[5];
		var start = $('#start' + n).html().split('"')[5];
		var end = $('#end' + n).html().split('"')[5];
		var status = $('#status' + n).html().split('"')[5];
		console.log(id + ', ' + start + ', ' + end + ', ' + status);
		$('#link' + n).html('<a class="label label-info" href="/sitemngr/editwormhole/' + n + '">Edit</a> <a class="label label-warning" onclick="edit(' + n + ')">In line</a>');
		$('#id' + n).html('<a href="/sitemngr/viewwormhole/' + n + '">' + id + '</a>');
		$('#start' + n).html('<a href="/sitemngr/system/' + start +'">' + start + '</a>');
		$('#end' + n).html('<a href="/sitemngr/system/' + end +'">' + end + '</a>');
		$('#status' + n).html(status);
		// $('#tr' + n + ' td:last-child').remove();
	}
	function save(n) {
		console.log('Save ' + n);
		$('#js_alerts_out').text('Saving...');
		$('#js_alerts').fadeIn(250);
		var id = $('#id' + n + '_edit').val();
		var start = $('#start' + n + '_edit').val();
		var end = $('#end' + n + '_edit').val();
		var status = $('#status' + n + '_edit').val();
		console.log(id + ', ' + start + ', ' + end + ', ' + status);
		var u = String("inlineeditwormhole/" + n);
		console.log(u);
		$.ajax({
		  type: "POST",
		  url: u,
		  data: {
		      id: id,
		      start: start,
		      end: end,
		      status: status
		  },
		  success: function(data) {
            alert('Success: ' + data);
		  },
          fail: function(data) {
              alert('Fail: ' + data);
              cancel(n);
              return;
          },
          error: function(data) {
              alert('Error: ' + data);
              cancel(n);
              return;
          }
        });
		$('#link' + n).html('<a class="label label-info" href="/sitemngr/editwormhole/' + n + '">Edit</a> <a class="label label-warning" onclick="edit(' + n + ')">In line</a>');
		$('#id' + n).html('<a href="/sitemngr/viewwormhole/' + n + '">' + id + '</a>');
		$('#start' + n).html('<a href="/sitemngr/system/' + start +'">' + start + '</a>');
		$('#end' + n).html('<a href="/sitemngr/system/' + end +'">' + end + '</a>');
		$('#status' + n).html(status);
		$('#js_alerts_out').text('Saved');
		$('#js_alerts').fadeOut(3000);
	}
</script>
{% endblock %}

{% block extraHead %}
<style>
	input[type="text"] {
		text-align: center;
		width: 75%;
	}
</style>
{% endblock %}

{% block content %}

<center>

{% if notices %}
    <div class="alert" id="alert_notices">
        <button type="button" class="close" onclick="$('#alert_notices').fadeOut(250);">&times;</button>
        {% for n in notices %}
            {{ n }}<br>
        {% endfor %}
    </div>
{% endif %}
{% if messages %}
    <div class="alert alert-error" id="alert_messages">
        <button type="button" class="close" onclick="$('#alert_messages').fadeOut(250);">&times;</button>
        {% for m in messages %}
            {{ m }}<br>
        {% endfor %}
    </div>
{% endif %}
{% if flag %}
    <div class="alert" id="alert_flag">
        <button type="button" class="close" onclick="$('#alert_flag').fadeOut(250);">&times;</button>
        {{ flag }}
    </div>
{% endif %}
<div class="alert" id="js_alerts" hidden>
	<button type="button" class="close" onclick="$('#js_alerts').fadeOut(250);">&times;</button>
	<p id="js_alerts_out"></p>
</div>

<div class="btn-group">
	<button class="btn" onclick="toggleSection('graph');">Toggle graph</button>
	<button class="btn" onclick="toggleSection('overlay');">Show Overview</button>
	<button class="btn" onclick="toggleSection('search');">Search</button>
	<button class="btn" onclick="toggleSection('index_paste');">Paste</button>
</div>

<br><br>

<div id="search" style="border: 1px solid gray; display: none;">
    <strong>Search box</strong><br>
    <a onclick="$('#omnibox_instructions').toggle(100);">Show instructions</a><br>
    <div id="omnibox_instructions" style="text-align: left; padding-left: 5px; display: none;">
        <strong>Search box</strong>
        <ul>
            <li>Start typing what you are looking for. If you're looking for a system, type the first part of it's name. Systems directly in the 
            chain are checked first, so you'll see them faster than some random system not in the chain. Same goes with tradehub systems.</li>
            <li>Typing <b>wormhole</b> or <b>site</b> (broken into <b>signature</b> and <b>anomaly</b>) will list all objects in the database of that type.</li>
            <li>If you're typing 1-3 letters in caps, the search will find all objects whose scan ids start with those letters.</li>
        </ul>
        <strong>Flags</strong>
        <ul>
            <li><i>o</i>: Only view open sites/wormholes</li>
            <li><i>c</i>: Only view closed sites/wormholes</li>
            <li><i>f</i>: Only view chain systems</li>
            <li><i>u</i>: View all systems</li>
            <li><i>m</i>: Only view systems</li>
            <li><i>w</i>: Only view wormholes</li>
            <li><i>s</i>: Only view sites</li>
        </ul>
        If you do not want to filter, leave the flags box blank.
    </div>
	<input type="text" id="omnibox" style="margin-top: 10px;" onkeyup="get_tags();" placeholder="Search...">
	<input type="text" id="omni_flags" style="margin-top: 10px; width: 10%;" onkeyup="get_tags();" placeholder="Flags">
	<img src="http://i.imgur.com/WWZwIWk.png" width="30" height="30" onclick="$('#omnibox').val(''); $('#omni_flags').val(''); $('#search_results').hide(); $('#search_results').html('');"><br>
	<div id="search_results" style="height: 200px; width: 50%; overflow: auto; display: none;"></div>
</div>
<div id="overlay" style="width: 100%; border: 1px solid black; display: none;">
    <span style="color: gray; text-align: left;">Loading ...</span>
</div>
<div id="graph" style="border: 1px solid gray; display: none;">
	<img src="{% static 'pictures/graph.png' %}" alt="Current graph not found"></img><br>
	<p>
    	<b>System outline colors</b>: HS = gold, LS = purple, NS = brown, C1 = blue, C2 = green, C3 = yellow, C4 = orange, C5 = red, C6 = black, not found = black<br>
		<b>Line styles</b>: Fresh = bold, < 50% mass & < 50% time = dashed, EoL & VoC = dotted, Unknown = standard<br>
		<i>Note</i>: Dotted red lines mean that the wormhole has been "Fresh" or "Unknown" for more than 16 hours
	</p>
</div>
<div id="index_paste" style="border: 1px solid gray; display: none;">
    <h4>This is the same thing as the paste page, without having to load that separate page before pasting.</h4>
    <form action="/sitemngr/paste/" method="POST">
    {% csrf_token %}
        <table style="border: none;">
            <tr style="border: none;">
                <td>
                    <label><b>System</b>:</label>
                </td>
                <td>
                    <input type="text" name="system" value="{% if system %}{{ system }}{% elif eveigb.is_igb %}{{ eveigb.solarsystemname }}{% else %}J132814{% endif %}">
                </td>
            </tr>
        </table><br>
        <textarea name="pastedata" rows="20" id="ta_pastedata">{% if raw %}{{ raw }}{% endif %}</textarea><br>
        <table style="border: none;">
            <tr style="border: none;">
                <td>
                    <label><b>After downtime?</b></label>
                </td>
                <td>
					<label class="checkbox">
						<input type="checkbox" name="downtime" id="c_paste_downtime">
					</label>
                </td>
            </tr>
        </table><br>
        <input type="submit" value="Parse" class="btn btn-primary" data-loading-text="Parsing..." onclick="$(this).button('loading');"> 
    </form>
</div>

<h5><a href="/sitemngr/system/{{ homesystem }}" id="tt1" data-toggle="tooltip" title="Direct link to the system overview page for the homesystem in settings, {{ homesystem }}">Home System Page</a></h5>

<h5>It is currently Eve time {% now 'H:i:s, N j' %}. Last update: {{ last_update_diff }} ago, by {{ last_update_user }}</h5>

<div class="row">
    <div class="span6">
        <h1 id="tt4" data-toggle="tooltip" title="A 'site' is a Cosmic Anomaly or a Cosmic Signature. Both are grouped under this name.">Index of {% if status and status == 'open' %}{% else %}closed {% endif %}sites</h1>
        <table class="hovertable">
            <thead>
                <tr>
                    <th> ID</th>
                    <th>Name
                    <th>Type</th>
                    <th>Location</th>
                    <th>Opened</th>
					<th>Entered</th>
					<th>Edit</th>
                </tr>
            </thread>
            <tbody>
                {% for s in sites %}
    				{% if s.isAnom %}
    				    <tr class="anom">
    				{% elif s.opened %}
    				    <tr class="open">
    				{% else %}
    				    <tr class="closed">
    				{% endif %}
    					<td><a href="/sitemngr/viewsite/{{ s.id }}">{{ s.scanid }}</a></td>
    					<td>{{ s.name }}</td>
    					<td>{{ s.type }}</td>
    					<td><a href="/sitemngr/system/{{ s.where }}">{{ s.where }}</a></td>
    					<td>{% if s.opened %}<span class="g">{{ s.opened }}</span>{% else %}<span class="r">{{ s.opened }}</span>{% endif %}</td>
    					<td>{{ s.date|date:'m/d @ H:i' }}</td>
    					<td><a class="label label-info" href="/sitemngr/editsite/{{ s.id }}" {% if newTab %}target="_blank"{% endif %}>Edit</a></td>
    				</tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="span6">
        <h1 id="tt5" data-toggle="tooltip" title="Wormholes start in one system and lead to another - the main method of transportantion for those living in wormhole-space.">Index of {% if status and status == 'open' %}{% else %}closed {% endif %}wormholes</h1>
        <table class="hovertable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Opened in</th>
                    <th>Leads to</th>
                    <th>Entered</th>
                    <th>Status</th>
                    <th>Edit</th>
                </tr>
            </thead>
            <tbody>
                {% for w in wormholes %}
    				{% if w.opened %}
    				<tr class="open">
    				{% else %}
    				<tr class="closed">
    				{% endif %}
    					<td id="id{{ w.id }}"><a href="/sitemngr/viewwormhole/{{ w.id }}">{{ w.scanid }}</a></td>
    					<td id="start{{ w.id }}"><a href="/sitemngr/system/{{ w.start }}">{{ w.start }}</a></td>
    					<td id="end{{ w.id }}">{% if w.destination == 'Unknown' or w.destination == '' or w.destination == 'Unopened' or w.destination == 'Closed' %}{{ w.destination }}{% else %}<a href="/sitemngr/system/{{ w.destination }}">{{ w.destination }}</a>{% endif %}</td>
    					<td>{{ w.date|date:'m/d @ H:i' }}</td>
    					<td id="status{{ w.id }}">{{ w.status }}</td>
    					<td id="link{{ w.id }}"><a class="label label-info" href="/sitemngr/editwormhole/{{ w.id }}" {% if newTab %}target="_blank"{% endif %}>Edit</a></td>
    					<!-- <td id="link{{ w.id }}"><a class="label label-info" href="/sitemngr/editwormhole/{{ w.id }}" {% if newTab %}target="_blank"{% endif %}>Edit</a> <a class="label label-warning" onclick="edit({{ w.id }});">In line</a></td> -->
    				</tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<br><br><br>
<p style="font-size: 200%;">
    {% if status and status == 'open' %}
        <a href="/sitemngr/viewall/" id="tt2" data-toggle="tooltip" title="View this index page in the same format, but only show closed sites and wormholes intead of the open entries">View closed</a>
    {% else %}
        <a href="/sitemngr/">Back</a>
    {% endif %}
    <br>
</p>
<a href="/sitemngr/refreshgraph/" id="tt3" data-toggle="tooltip" title="Use this to force the wormhole chain graph to update. This shouldn't ever be needed, but just in case someone makes edits directly on the database, use this page.">Manually refresh graph</a>

</center>

{% endblock %}
